ma = library("maths.lib");
ba = library("basics.lib");
de = library("delays.lib");
ro = library("routes.lib");
si = library("signals.lib");
fi = library("filters.lib");
os = library("oscillators.lib");
it = library("interpolators.lib");
ef = library("misceffects.lib");
sp = library("spats.lib");
aa = library("aanl.lib");
an = library("analyzers.lib");
declare rev_stereo author "Jonas Schenkyr";

rev_stereo = _,_<:_,_,_,_,_,_:rev_left,rev_right,(xgain*rev_right),(xgain*rev_left),_*direct_gain,_*direct_gain:route(6,4,(1,1),(2,2),(3,2),(4,1),(5,3),(6,4)):(lc:hi_shelf(hg,hf)*wet_gain),(lc:hi_shelf(hg,hf)*wet_gain),_,_:de.sdelay(predelay*2,512,predelay),de.sdelay(predelay*2,512,predelay+spread),_,_:>_,_
with{
N = 16; // number of delay lines per channel

//Feedback Matrix gains
//Matrix1
a(1,1)=0.749491035938263; 
a(1,2)=-0.164882078766823; 
a(1,3)=0.121069505810738; 
a(1,4)=0.171796306967735; 
a(1,5)=-0.160083517432213; 
a(1,6)=0.0907029882073402; 
a(1,7)=-0.111894957721233; 
a(1,8)=0.141317144036293; 
a(1,9)=0.192545875906944; 
a(1,10)=0.13998456299305; 
a(1,11)=-0.0423076301813126; 
a(1,12)=-0.184468120336533; 
a(1,13)=0.318761914968491; 
a(1,14)=-0.176014393568039; 
a(1,15)=-0.0716488435864449; 
a(1,16)=0.257467538118362; 
a(2,1)=0.229909136891365; 
a(2,2)=0.83818656206131; 
a(2,3)=-0.120065152645111; 
a(2,4)=-0.0728229880332947; 
a(2,5)=0.102821558713913; 
a(2,6)=0.1636853069067; 
a(2,7)=0.0544019676744938; 
a(2,8)=-0.112043015658855; 
a(2,9)=-0.18822093307972; 
a(2,10)=0.213725417852402; 
a(2,11)=-0.00267532421275973; 
a(2,12)=0.096269816160202; 
a(2,13)=-0.0612178705632687; 
a(2,14)=-0.191517904400826; 
a(2,15)=0.135638952255249; 
a(2,16)=0.139157727360725; 
a(3,1)=-0.0388588942587376; 
a(3,2)=0.0740681737661362; 
a(3,3)=0.843879103660584; 
a(3,4)=-0.174372777342796; 
a(3,5)=0.135359972715378; 
a(3,6)=0.103241488337517; 
a(3,7)=-0.223536655306816; 
a(3,8)=-0.0396599918603897; 
a(3,9)=-0.140207752585411; 
a(3,10)=-0.105424664914608; 
a(3,11)=0.117478087544441; 
a(3,12)=0.0436576120555401; 
a(3,13)=0.0954775512218475; 
a(3,14)=0.205803498625755; 
a(3,15)=0.215431228280067; 
a(3,16)=0.147681266069412; 
a(4,1)=-0.149932280182838; 
a(4,2)=0.125789821147919; 
a(4,3)=0.268032789230347; 
a(4,4)=0.858589291572571; 
a(4,5)=0.106228977441788; 
a(4,6)=0.0368754118680954; 
a(4,7)=0.180912107229233; 
a(4,8)=0.123380534350872; 
a(4,9)=0.0950266793370247; 
a(4,10)=0.116344332695007; 
a(4,11)=-0.0850845873355866; 
a(4,12)=0.201675325632095; 
a(4,13)=-0.0311348289251328; 
a(4,14)=-0.0288379807025194; 
a(4,15)=-0.0516428425908089; 
a(4,16)=-0.116709873080254; 
a(5,1)=0.122837491333485; 
a(5,2)=-0.142357781529427; 
a(5,3)=-0.104469813406467; 
a(5,4)=-0.0881874412298203; 
a(5,5)=0.905184686183929; 
a(5,6)=-0.0016637600492686; 
a(5,7)=-0.112003304064274; 
a(5,8)=0.00775955198332667; 
a(5,9)=0.190792664885521; 
a(5,10)=0.156988963484764; 
a(5,11)=0.080343171954155; 
a(5,12)=0.0801938995718956; 
a(5,13)=0.0982548445463181; 
a(5,14)=-0.0561899319291115; 
a(5,15)=-0.0177325792610645; 
a(5,16)=-0.152187705039978; 
a(6,1)=-0.11413336545229; 
a(6,2)=-0.162608996033669; 
a(6,3)=-0.143201068043709; 
a(6,4)=0.00745704816654325; 
a(6,5)=-0.0160160325467587; 
a(6,6)=0.852430999279022; 
a(6,7)=-0.118867121636868; 
a(6,8)=-0.128039732575417; 
a(6,9)=0.0494593754410744; 
a(6,10)=-0.192692533135414; 
a(6,11)=-0.217112213373184; 
a(6,12)=0.269547492265701; 
a(6,13)=0.0760945752263069; 
a(6,14)=-0.0653540715575218; 
a(6,15)=0.0238841231912375; 
a(6,16)=0.0909581482410431; 
a(7,1)=0.000366342574125156; 
a(7,2)=-0.10236769169569; 
a(7,3)=0.128587305545807; 
a(7,4)=-0.190941110253334; 
a(7,5)=0.133769392967224; 
a(7,6)=0.22861160337925; 
a(7,7)=0.85639101266861; 
a(7,8)=0.160284385085106; 
a(7,9)=-0.0402876771986485; 
a(7,10)=0.101512931287289; 
a(7,11)=-0.0275675617158413; 
a(7,12)=-0.217859834432602; 
a(7,13)=-0.00609539216384292; 
a(7,14)=0.108276024460793; 
a(7,15)=-0.0344404056668282; 
a(7,16)=0.172263517975807; 
a(8,1)=-0.24240717291832; 
a(8,2)=0.18660931289196; 
a(8,3)=-0.140601381659508; 
a(8,4)=-0.0659976303577423; 
a(8,5)=0.0057487590238452; 
a(8,6)=0.04715695977211; 
a(8,7)=-0.145990192890167; 
a(8,8)=0.848505437374115; 
a(8,9)=0.131197154521942; 
a(8,10)=-0.130678728222847; 
a(8,11)=0.143403306603432; 
a(8,12)=0.00228874105960131; 
a(8,13)=0.198540195822716; 
a(8,14)=0.0013833842240274; 
a(8,15)=0.101912058889866; 
a(8,16)=0.171244874596596; 
a(9,1)=-0.208791866898537; 
a(9,2)=0.119548946619034; 
a(9,3)=0.0173077322542667; 
a(9,4)=-0.0729614347219467; 
a(9,5)=-0.131052047014236; 
a(9,6)=-0.0531527251005173; 
a(9,7)=0.091009721159935; 
a(9,8)=-0.293995171785355; 
a(9,9)=0.813177347183228; 
a(9,10)=0.138304978609085; 
a(9,11)=0.173812210559845; 
a(9,12)=0.0364648811519146; 
a(9,13)=0.098459355533123; 
a(9,14)=0.0212642550468445; 
a(9,15)=0.240556046366692; 
a(9,16)=0.19120492041111; 
a(10,1)=-0.302444607019424; 
a(10,2)=-0.148038282990456; 
a(10,3)=0.0354182086884975; 
a(10,4)=-0.0555883161723614; 
a(10,5)=-0.0888938084244728; 
a(10,6)=0.135826528072357; 
a(10,7)=-0.239826843142509; 
a(10,8)=0.05045585334301; 
a(10,9)=-0.139466345310211; 
a(10,10)=0.832521200180054; 
a(10,11)=0.0138848191127181; 
a(10,12)=-0.105274833738804; 
a(10,13)=-0.0656976848840714; 
a(10,14)=-0.00989930704236031; 
a(10,15)=-0.18263067305088; 
a(10,16)=0.170026406645775; 
a(11,1)=0.0623907074332237; 
a(11,2)=-0.107922799885273; 
a(11,3)=-0.112055003643036; 
a(11,4)=0.13042388856411; 
a(11,5)=-0.0588199272751808; 
a(11,6)=0.110778398811817; 
a(11,7)=0.0901605635881424; 
a(11,8)=-0.104215137660503; 
a(11,9)=-0.195087283849716; 
a(11,10)=-0.0346078537404537; 
a(11,11)=0.893106043338776; 
a(11,12)=0.225040376186371; 
a(11,13)=0.062375895678997; 
a(11,14)=-0.00488223228603601; 
a(11,15)=-0.116111405193806; 
a(11,16)=0.0959506332874298; 
a(12,1)=0.196878209710121; 
a(12,2)=-0.0804733410477638; 
a(12,3)=0.101272322237492; 
a(12,4)=-0.256318628787994; 
a(12,5)=-0.1134083122015; 
a(12,6)=-0.181079462170601; 
a(12,7)=0.114281162619591; 
a(12,8)=0.181695684790611; 
a(12,9)=0.097567155957222; 
a(12,10)=0.127480790019035; 
a(12,11)=-0.146139338612556; 
a(12,12)=0.810911536216736; 
a(12,13)=-0.179380491375923; 
a(12,14)=0.0478234887123108; 
a(12,15)=-0.195493534207344; 
a(12,16)=0.0596626587212086; 
a(13,1)=-0.117769427597523; 
a(13,2)=0.0116766728460789; 
a(13,3)=-0.132066905498505; 
a(13,4)=0.00759829953312874; 
a(13,5)=-0.0439640656113625; 
a(13,6)=-0.160806581377983; 
a(13,7)=0.119198709726334; 
a(13,8)=-0.144260510802269; 
a(13,9)=-0.238040685653687; 
a(13,10)=0.127290084958076; 
a(13,11)=-0.154415160417557; 
a(13,12)=0.209642365574837; 
a(13,13)=0.835102558135986; 
a(13,14)=0.204793810844421; 
a(13,15)=0.122270330786705; 
a(13,16)=-0.0612858571112156; 
a(14,1)=0.217317685484886; 
a(14,2)=0.0473153777420521; 
a(14,3)=-0.235043689608574; 
a(14,4)=0.159912198781967; 
a(14,5)=0.0465155728161335; 
a(14,6)=0.0668448582291603; 
a(14,7)=-0.104338780045509; 
a(14,8)=0.0127874705940485; 
a(14,9)=0.024286424741149; 
a(14,10)=0.0598387382924557; 
a(14,11)=-0.0233998280018568; 
a(14,12)=-0.030836708843708; 
a(14,13)=-0.194920316338539; 
a(14,14)=0.874989032745361; 
a(14,15)=0.110880687832832; 
a(14,16)=0.15170893073082; 
a(15,1)=0.117821164429188; 
a(15,2)=-0.268595695495605; 
a(15,3)=-0.0672415122389793; 
a(15,4)=0.0435842238366604; 
a(15,5)=-0.0776455476880074; 
a(15,6)=0.00603848369792104; 
a(15,7)=0.0624837540090084; 
a(15,8)=0.114483051002026; 
a(15,9)=-0.135848507285118; 
a(15,10)=0.200275421142578; 
a(15,11)=0.0386479049921036; 
a(15,12)=0.104411229491234; 
a(15,13)=-0.171306744217873; 
a(15,14)=-0.151624858379364; 
a(15,15)=0.849719822406769; 
a(15,16)=-0.17622996866703; 
a(16,1)=-0.139749780297279; 
a(16,2)=-0.159663796424866; 
a(16,3)=-0.121847845613956; 
a(16,4)=0.164717003703117; 
a(16,5)=0.204179301857948; 
a(16,6)=-0.267009496688843; 
a(16,7)=-0.0141500048339367; 
a(16,8)=-0.130298718810081; 
a(16,9)=-0.179239958524704; 
a(16,10)=-0.16043421626091; 
a(16,11)=-0.144128784537315; 
a(16,12)=0.065991573035717; 
a(16,13)=-0.085563987493515; 
a(16,14)=-0.168392479419708; 
a(16,15)=0.11680394411087; 
a(16,16)=0.801501035690308; 

//Matrix2
a2(1,1)=0.749498248100281; 
a2(1,2)=-0.164872586727142; 
a2(1,3)=0.121057882905006; 
a2(1,4)=0.171807855367661; 
a2(1,5)=-0.160072758793831; 
a2(1,6)=0.0907047316431999; 
a2(1,7)=-0.111885294318199; 
a2(1,8)=0.141322568058968; 
a2(1,9)=0.192529246211052; 
a2(1,10)=0.13999530673027; 
a2(1,11)=-0.0423051975667477; 
a2(1,12)=-0.184484049677849; 
a2(1,13)=0.318728268146515; 
a2(1,14)=-0.17601777613163; 
a2(1,15)=-0.0716426596045494; 
a2(1,16)=0.257487297058105; 
a2(2,1)=0.229911342263222; 
a2(2,2)=0.838138282299042; 
a2(2,3)=-0.120053634047508; 
a2(2,4)=-0.0728278830647469; 
a2(2,5)=0.1028146520257; 
a2(2,6)=0.163688451051712; 
a2(2,7)=0.0543972663581371; 
a2(2,8)=-0.11204732209444; 
a2(2,9)=-0.188204675912857; 
a2(2,10)=0.213741824030876; 
a2(2,11)=-0.00267517031170428; 
a2(2,12)=0.0962781310081482; 
a2(2,13)=-0.0612114071846008; 
a2(2,14)=-0.19152158498764; 
a2(2,15)=0.135627239942551; 
a2(2,16)=0.139168411493301; 
a2(3,1)=-0.0388592667877674; 
a2(3,2)=0.0740639120340347; 
a2(3,3)=0.843798100948334; 
a2(3,4)=-0.174384489655495; 
a2(3,5)=0.13535088300705; 
a2(3,6)=0.103243470191956; 
a2(3,7)=-0.22351735830307; 
a2(3,8)=-0.0396615117788315; 
a2(3,9)=-0.140195652842522; 
a2(3,10)=-0.105432756245136; 
a2(3,11)=0.11747132986784; 
a2(3,12)=0.0436613820493221; 
a2(3,13)=0.0954674780368805; 
a2(3,14)=0.205807447433472; 
a2(3,15)=0.215412631630898; 
a2(3,16)=0.147692605853081; 
a2(4,1)=-0.149933710694313; 
a2(4,2)=0.125782579183579; 
a2(4,3)=0.268007069826126; 
a2(4,4)=0.858646929264069; 
a2(4,5)=0.106221839785576; 
a2(4,6)=0.0368761196732521; 
a2(4,7)=0.180896490812302; 
a2(4,8)=0.123385272920132; 
a2(4,9)=0.0950184762477875; 
a2(4,10)=0.116353258490562; 
a2(4,11)=-0.0850796923041344; 
a2(4,12)=0.20169273018837; 
a2(4,13)=-0.0311315432190895; 
a2(4,14)=-0.0288385357707739; 
a2(4,15)=-0.0516383834183216; 
a2(4,16)=-0.116718836128712; 
a2(5,1)=0.1228386759758; 
a2(5,2)=-0.142349570989609; 
a2(5,3)=-0.104459792375565; 
a2(5,4)=-0.0881933644413948; 
a2(5,5)=0.905123889446259; 
a2(5,6)=-0.00166379194706678; 
a2(5,7)=-0.111993633210659; 
a2(5,8)=0.00775985047221184; 
a2(5,9)=0.190776199102402; 
a2(5,10)=0.15700101852417; 
a2(5,11)=0.0803385525941849; 
a2(5,12)=0.0802008286118507; 
a2(5,13)=0.0982444807887077; 
a2(5,14)=-0.056191012263298; 
a2(5,15)=-0.0177310481667519; 
a2(5,16)=-0.152199387550354; 
a2(6,1)=-0.114134460687637; 
a2(6,2)=-0.162599623203278; 
a2(6,3)=-0.143187329173088; 
a2(6,4)=0.0074575487524271; 
a2(6,5)=-0.0160149578005075; 
a2(6,6)=0.852447330951691; 
a2(6,7)=-0.118856854736805; 
a2(6,8)=-0.128044649958611; 
a2(6,9)=0.049455102533102; 
a2(6,10)=-0.192707315087318; 
a2(6,11)=-0.217099726200104; 
a2(6,12)=0.269570767879486; 
a2(6,13)=0.076086550951004; 
a2(6,14)=-0.0653553307056427; 
a2(6,15)=0.0238820612430573; 
a2(6,16)=0.090965136885643; 
a2(7,1)=0.000366346095688641; 
a2(7,2)=-0.102361798286438; 
a2(7,3)=0.128574967384338; 
a2(7,4)=-0.190953925251961; 
a2(7,5)=0.133760407567024; 
a2(7,6)=0.228615984320641; 
a2(7,7)=0.856317043304443; 
a2(7,8)=0.16029055416584; 
a2(7,9)=-0.0402842015028; 
a2(7,10)=0.101520724594593; 
a2(7,11)=-0.0275659766048193; 
a2(7,12)=-0.21787865459919; 
a2(7,13)=-0.00609474908560514; 
a2(7,14)=0.10827811062336; 
a2(7,15)=-0.03443743288517; 
a2(7,16)=0.172276750206947; 
a2(8,1)=-0.242409497499466; 
a2(8,2)=0.186598569154739; 
a2(8,3)=-0.140587881207466; 
a2(8,4)=-0.0660020634531975; 
a2(8,5)=0.00574837299063802; 
a2(8,6)=0.0471578650176525; 
a2(8,7)=-0.145977586507797; 
a2(8,8)=0.848538041114807; 
a2(8,9)=0.131185829639435; 
a2(8,10)=-0.13068875670433; 
a2(8,11)=0.14339505136013; 
a2(8,12)=0.00228893873281777; 
a2(8,13)=0.198519244790077; 
a2(8,14)=0.00138341076672077; 
a2(8,15)=0.101903259754181; 
a2(8,16)=0.171258017420769; 
a2(9,1)=-0.208793863654137; 
a2(9,2)=0.119542062282562; 
a2(9,3)=0.0173060707747936; 
a2(9,4)=-0.0729663297533989; 
a2(9,5)=-0.131043240427971; 
a2(9,6)=-0.0531537458300591; 
a2(9,7)=0.0910018607974052; 
a2(9,8)=-0.29400646686554; 
a2(9,9)=0.813107132911682; 
a2(9,10)=0.138315588235855; 
a2(9,11)=0.173802211880684; 
a2(9,12)=0.0364680290222168; 
a2(9,13)=0.0984489619731903; 
a2(9,14)=0.0212646629661322; 
a2(9,15)=0.240535274147987; 
a2(9,16)=0.191219612956047; 
a2(10,1)=-0.302447497844696; 
a2(10,2)=-0.148029744625092; 
a2(10,3)=0.0354148074984551; 
a2(10,4)=-0.0555920489132404; 
a2(10,5)=-0.0888878405094147; 
a2(10,6)=0.135829135775566; 
a2(10,7)=-0.239806115627289; 
a2(10,8)=0.0504577942192555; 
a2(10,9)=-0.139454305171967; 
a2(10,10)=0.832585096359253; 
a2(10,11)=0.0138840200379491; 
a2(10,12)=-0.105283923447132; 
a2(10,13)=-0.0656907483935356; 
a2(10,14)=-0.00989949703216553; 
a2(10,15)=-0.182614907622337; 
a2(10,16)=0.170039474964142; 
a2(11,1)=0.0623913034796715; 
a2(11,2)=-0.107916586101055; 
a2(11,3)=-0.112044245004654; 
a2(11,4)=0.130432650446892; 
a2(11,5)=-0.0588159747421742; 
a2(11,6)=0.110780522227287; 
a2(11,7)=0.0901527777314186; 
a2(11,8)=-0.104219146072865; 
a2(11,9)=-0.195070445537567; 
a2(11,10)=-0.0346105098724365; 
a2(11,11)=0.893054664134979; 
a2(11,12)=0.225059807300568; 
a2(11,13)=0.0623693130910397; 
a2(11,14)=-0.00488232634961605; 
a2(11,15)=-0.116101376712322; 
a2(11,16)=0.0959580019116402; 
a2(12,1)=0.196880102157593; 
a2(12,2)=-0.0804687067866325; 
a2(12,3)=0.101262606680393; 
a2(12,4)=-0.256335854530335; 
a2(12,5)=-0.113400690257549; 
a2(12,6)=-0.181082934141159; 
a2(12,7)=0.1142712906003; 
a2(12,8)=0.18170265853405; 
a2(12,9)=0.0975587293505669; 
a2(12,10)=0.12749058008194; 
a2(12,11)=-0.146130934357643; 
a2(12,12)=0.810981571674347; 
a2(12,13)=-0.179361566901207; 
a2(12,14)=0.0478244088590145; 
a2(12,15)=-0.195476651191711; 
a2(12,16)=0.0596672371029854; 
a2(13,1)=-0.117770560085773; 
a2(13,2)=0.0116759994998574; 
a2(13,3)=-0.13205423951149; 
a2(13,4)=0.00759880989789963; 
a2(13,5)=-0.0439611114561558; 
a2(13,6)=-0.16080966591835; 
a2(13,7)=0.119188413023949; 
a2(13,8)=-0.144266039133072; 
a2(13,9)=-0.2380201369524; 
a2(13,10)=0.12729986011982; 
a2(13,11)=-0.154406279325485; 
a2(13,12)=0.209660470485687; 
a2(13,13)=0.835014402866364; 
a2(13,14)=0.204797744750977; 
a2(13,15)=0.122259773313999; 
a2(13,16)=-0.0612905658781529; 
a2(14,1)=0.217319771647453; 
a2(14,2)=0.0473126508295536; 
a2(14,3)=-0.235021129250526; 
a2(14,4)=0.159922942519188; 
a2(14,5)=0.0465124472975731; 
a2(14,6)=0.066846139729023; 
a2(14,7)=-0.104329764842987; 
a2(14,8)=0.0127879614010453; 
a2(14,9)=0.0242843274027109; 
a2(14,10)=0.0598433315753937; 
a2(14,11)=-0.0233984831720591; 
a2(14,12)=-0.0308393724262714; 
a2(14,13)=-0.19489973783493; 
a2(14,14)=0.875005841255188; 
a2(14,15)=0.110871113836765; 
a2(14,16)=0.151720583438873; 
a2(15,1)=0.117822296917439; 
a2(15,2)=-0.268580228090286; 
a2(15,3)=-0.0672350600361824; 
a2(15,4)=0.0435871481895447; 
a2(15,5)=-0.0776403322815895; 
a2(15,6)=0.00603859964758158; 
a2(15,7)=0.0624783560633659; 
a2(15,8)=0.114487446844578; 
a2(15,9)=-0.135836780071259; 
a2(15,10)=0.200290784239769; 
a2(15,11)=0.0386456809937954; 
a2(15,12)=0.104420252144337; 
a2(15,13)=-0.171288654208183; 
a2(15,14)=-0.151627764105797; 
a2(15,15)=0.84964644908905; 
a2(15,16)=-0.176243498921394; 
a2(16,1)=-0.139751121401787; 
a2(16,2)=-0.159654602408409; 
a2(16,3)=-0.121836148202419; 
a2(16,4)=0.164728075265884; 
a2(16,5)=0.20416559278965; 
a2(16,6)=-0.267014622688293; 
a2(16,7)=-0.0141487829387188; 
a2(16,8)=-0.130303725600243; 
a2(16,9)=-0.179224476218224; 
a2(16,10)=-0.160446524620056; 
a2(16,11)=-0.144120499491692; 
a2(16,12)=0.0659972727298737; 
a2(16,13)=-0.0855549573898315; 
a2(16,14)=-0.168395712971687; 
a2(16,15)=0.116793856024742; 
a2(16,16)=0.801562547683716; 

a(m,n) = 0; // catch missing values
a2(m,n) = 0;


matrix(N,f) = si.bus(N) <:ro.interleave(N,N) : par(n,N, par(m,N,*(fb*f(m+1,n+1)))):>si.bus(N);
A = matrix(N,a);
A2 = matrix(N,a2);

fb_matrix = (A);
fb_matrix2 = (A2);

// Delay-line lengths in samples:
delaysamples = (241,271,293,331,359,401,443,487,523,587,647,709,787,863,953,1049); 
delaysamples2 = (239,283,313,317,373,397,461,479,541,571,659,691,809,859,971,1033);


delaytimes(i) = ba.take(i+1,delaysamples)*scale;
delaytimes2(i) = ba.take(i+1,delaysamples2)*scale;

fbdelaylines(N) = par(i,N,(de.fdelay(3000,(delaytimes(i)))));
fbdelaylines2(N) = par(i,N,(de.fdelay(3000,(delaytimes2(i)))));
delays = fbdelaylines(N);
delays2 = fbdelaylines2(N);

apcoeff(i) = select2(i&1,0.6,-0.6);
nextpow2(x) = ceil(log(x)/log(2.0));

//Allpass Filters
allpasscomb(maxdel,N,aN) = (+ <: de.delay(maxdel,N-1),*(aN)) ~ *(-aN) : mem,_ : +;
apdelays = (101,151,199,263,317,103,157,211,269,331,23,53,173,83,47,269);
apdelays2 = (11,223,89,131,29,271,97,19,293,151,61,191,179,37,389,241);
apdelay(i) = floor(0.5 + ba.take(i+1,apdelays));
apdelay2(i) = floor(0.5 + ba.take(i+1,apdelays2));
apdelaymaxfs(i) = floor(0.5 + ba.take(i+1,apdelays));
apdelaymaxfs2(i) = floor(0.5 + ba.take(i+1,apdelays2));
maxapdelay(i) = int(2.0^max(1.0,nextpow2(apdelaymaxfs(i))));
maxapdelay2(i) = int(2.0^max(1.0,nextpow2(apdelaymaxfs2(i))));
allpass_combs(N) = par(i,N,(allpasscomb(maxapdelay(i),apdelay(i),apcoeff(i))));
allpass_combs2(N) = par(i,N,(allpasscomb(maxapdelay2(i),apdelay2(i),apcoeff(i))));

//Reverbs left right
rev_left = _<:((si.bus(2*N):>delays)~(fb_matrix:allpass_combs(N))):>_;
rev_right = _<:((si.bus(2*N):>delays2)~(fb_matrix2:allpass_combs2(N))):>_;

//High-shelf filter frequency and gain
filterbank(O,lfreqs) = an.analyzer(O,lfreqs) : delayeq(nb) 
with {
   nb = ba.count(lfreqs);
   fc(n) = ba.take(n, lfreqs);
   ap(n) = highpass_plus_lowpass(O,fc(n));
   delayeq(1) = _,_; 
   delayeq(nb) = par(i,nb-1,apchain(nb-1-i)),_,_;
   apchain(0) = _;
   apchain(i) = ap(i) : apchain(i-1);
};
highshelf(N,Lpi,fx) = filterbank(N,(fx)) : *(ba.db2linear(Lpi)), _ :> _;
hi_shelf = highshelf(3); // default = 3rd order Butterworth


//lowcut
lc = fi.highpass(1,lc_freq);

predelay = predms*0.001*48000; //predelay in samples
predms = hslider("[0]predelay",15,0,500,1); //predelay in ms

//fb = hslider("[1]length[scale:exp]",0.96,0.65,1.00,0.0001); //reverb length
fb = length*0.35+0.65;
length = hslider("[1]length[scale:exp]",0.7,0.001,1,0.001);

scale = hslider("[2]size[scale:log]",1,0.01,10,0.0001);
lc_freq = hslider("[3]lowcut frequency",60,10,6300,1);
hg = hslider("[4]highshelf gain",-20,-80,20,0.001);
hf = hslider("[5]highshelf frequency",2000,450,20000,0.001);
xgain = hslider("[6]xfeed",0.0,0,1,0.0001);

//spread = hslider("[7]stereo width",0,0,1440,1);
spread = widthms*0.001*48000;
widthms = hslider("[7]stereo width",0,0,30,0.1);
direct_gain = hslider("[8]dry[scale:log]",0.5,0.0001,1,0.0001);
wet_gain = hslider("[9]wet[scale:log]",0.35,0.0001,1,0.0001);
};


process = rev_stereo;